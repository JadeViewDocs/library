<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JadeView WinUI Demo</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" type="image/png" href="/favicon.png">
</head>

<body>
    <div class="custom-title-bar" style="
  app-region: drag; 
">
        <div class="title-left">
            <img class="title-bar-icon" src="./favicon.png" alt="Logo">
            JadeView WinUI Demo
        </div>
        <div class="title-right">
            <button type="button" class="window-btn btn-doc" onclick="window.open('https://jade.run/', '_blank')"
                title="å¼€å‘æ–‡æ¡£"><i></i></button>
            <button type="button" class="window-btn btn-minimize" onclick="sendWindowAction('minimize')"
                title="æœ€å°åŒ–çª—å£"><i></i></button>
            <button type="button" class="window-btn btn-maximize" onclick="sendWindowAction('maximize')"
                title="æœ€å¤§åŒ–çª—å£"><i></i></button>
            <button type="button" class="window-btn btn-close" onclick="sendWindowAction('close')"
                title="å…³é—­çª—å£"><i></i></button>
        </div>
    </div>
    <div class="app-window">
        <!-- å·¦ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="left-panel">
            <div class="chat-area" id="chatContainer">
            </div>

            <div class="input-area">
                <input type="text" id="msgInput" placeholder="å‘é€IPCæ¶ˆæ¯" autocomplete="off">
                <button type="button" id="sendBtn" onclick="sendMessage()">å‘é€</button>
            </div>
        </div>

        <!-- å³ä¾§è®¾ç½®åŒºåŸŸ -->
        <div class="right-panel">
            <div class="header">
                <h3>ä»¿WinUI3 çš„è®¾ç½®ç•Œé¢</h3>

                <span class="section-title">è®¾ç½®èƒŒæ™¯ææ–™</span>
                <div class="btn-group" id="backdropGroup">
                    <button type="button" onclick="setBackdrop('mica')">Mica</button>
                    <button type="button" onclick="setBackdrop('micaAlt')">Mica Alt</button>
                    <button type="button" onclick="setBackdrop('acrylic')">Acrylic</button>
                </div>

                <span class="section-title">ä¸»é¢˜è®¾ç½®</span>
                <div class="btn-group" id="themeGroup">
                    <button type="button" onclick="setTheme('Light')">æµ…è‰²</button>
                    <button type="button" onclick="setTheme('Dark')">æš—è‰²</button>
                    <button type="button" onclick="setTheme('System')" class="theme-active">è·Ÿéšç³»ç»Ÿ</button>
                </div>

            </div>

            <!-- æ–‡æ¡£é“¾æ¥å¡ç‰‡ -->
            <div class="doc-cards">
                <span class="section-title">æ–‡æ¡£é“¾æ¥</span>
                <div class="cards-grid">
                    <a href="https://jade.run/spec/quickstart" class="doc-card" target="_blank">
                        <div class="card-icon">ğŸ“–</div>
                        <div class="card-content">
                            <div class="card-title">å¿«é€Ÿå…¥é—¨</div>
                            <div class="card-desc">å¼€å§‹ä½¿ç”¨ JadeView</div>
                        </div>
                    </a>

                    <a href="https://jade.run/guidesi" class="doc-card" target="_blank">
                        <div class="card-icon">âš™ï¸</div>
                        <div class="card-content">
                            <div class="card-title">Apiæ–‡æ¡£</div>
                            <div class="card-desc">äº‹ä»¶ç±»å‹ï¼Œæ–¹æ³•ï¼Œå±æ€§ç­‰ç­‰</div>
                        </div>
                    </a>

                    <a href="https://qm.qq.com/q/pL3Lo2kAgg" class="doc-card" target="_blank">
                        <div class="card-icon">â­</div>
                        <div class="card-content">
                            <div class="card-title">QQç¾¤</div>
                            <div class="card-desc">äº¤æµåé¦ˆå’Œè®¨è®º</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä½¿ç”¨æ–°çš„invoke APIè°ƒç”¨åç«¯æ–¹æ³•
        async function setTheme(theme) {
            try {
                const payload = await jade.invoke('setTheme', theme);
                activateThemeButton(payload);
            } catch (error) {
                console.error('è®¾ç½®ä¸»é¢˜å¤±è´¥:', error);
            }
        }

        async function setBackdrop(backdropType) {
            try {
                const newBackdropType = await jade.invoke('setBackdrop', backdropType);
                console.log('è®¾ç½®èƒŒæ™¯ææ–™:', newBackdropType);
                // æ¿€æ´»å¯¹åº”çš„èƒŒæ™¯ææ–™æŒ‰é’®
                activateBackdropButton(newBackdropType);
            } catch (error) {
                console.error('è®¾ç½®èƒŒæ™¯ææ–™å¤±è´¥:', error);
            }
        }
        // ========================
        // 1. å‘é€æ¶ˆæ¯åŠŸèƒ½ (ä½¿ç”¨jade.ipcSend)
        // ========================
        const input = document.getElementById('msgInput');
        const chatContainer = document.getElementById('chatContainer');

        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            // åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„JSONæ¶ˆæ¯
            // æ˜¾ç¤ºå‘é€çš„æ¶ˆæ¯
            const sentMsgDiv = document.createElement('div');
            sentMsgDiv.classList.add('message', 'sent');
            const now = new Date();
            sentMsgDiv.innerHTML = `
                    <div class="msg-content">${text}</div>
                    <div class="msg-time">${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3, '0')}</div>
                `;
            chatContainer.appendChild(sentMsgDiv);
            try {
                // ä½¿ç”¨æ–°çš„invoke APIå‘é€æ¶ˆæ¯å¹¶ç›´æ¥è·å–è¿”å›ç»“æœ
                const result = await jade.invoke('message', text);
                // æ˜¾ç¤ºè¿”å›çš„ç»“æœ
                const receivedMsgDiv = document.createElement('div');
                receivedMsgDiv.classList.add('message', 'received');
                receivedMsgDiv.innerHTML = `
                    <div class="msg-content">${result.data || result}</div>
                    <div class="msg-time">${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3, '0')}</div>
                `;
                chatContainer.appendChild(receivedMsgDiv);

                chatContainer.scrollTop = chatContainer.scrollHeight;
                input.value = '';
                input.focus();
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // å›è½¦å‘é€
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // ========================
        // 2. ä¸»é¢˜æŒ‰é’®æ¿€æ´»åŠŸèƒ½
        // ========================
        function activateThemeButton(theme) {
            const themeGroup = document.getElementById('themeGroup');
            if (!themeGroup) return;

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            const buttons = themeGroup.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.remove('theme-active');
            });

            // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
            const targetButton = Array.from(buttons).find(btn =>
                btn.textContent.toLowerCase() === theme.toLowerCase() ||
                btn.getAttribute('onclick')?.includes(theme)
            );

            if (targetButton) {
                targetButton.classList.add('theme-active');
            }
        }

        // ========================
        // 3. èƒŒæ™¯ææ–™æŒ‰é’®æ¿€æ´»åŠŸèƒ½
        // ========================
        function activateBackdropButton(backdropType) {
            const backdropGroup = document.getElementById('backdropGroup');
            if (!backdropGroup) return;

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            const buttons = backdropGroup.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.remove('theme-active');
            });

            // æ¿€æ´»å¯¹åº”çš„æŒ‰é’®
            const targetButton = Array.from(buttons).find(btn =>
                btn.textContent.toLowerCase() === backdropType ||
                btn.getAttribute('onclick')?.includes(backdropType)
            );

            if (targetButton) {
                targetButton.classList.add('theme-active');
            }
        }

        // æ£€æµ‹æ˜¯å¦ä¸ºWindows 11
        async function isWindows11() {
            // æ–¹æ³•1ï¼šä½¿ç”¨navigator.userAgentDataï¼ˆç°ä»£æµè§ˆå™¨ï¼‰
            if (navigator.userAgentData) {
                try {
                    const uaData = await navigator.userAgentData.getHighEntropyValues(['platformVersion']);
                    console.log('UA Data:', uaData);
                    if (uaData.platform === 'Windows') {
                        const platformVersion = uaData.platformVersion;
                        const build = parseInt(platformVersion.split('.')[0]);
                        console.log('Windows Build:', build);
                        if (build >= 22000) {
                            return true;
                        }
                    }
                } catch (e) {
                    console.error('è·å–å¹³å°ç‰ˆæœ¬å¤±è´¥:', e);
                }
            }

            // æ–¹æ³•2ï¼šä½¿ç”¨ä¼ ç»Ÿçš„userAgentå­—ç¬¦ä¸²ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
            const userAgent = navigator.userAgent;
            console.log('User Agent:', userAgent);
            if (userAgent.includes('Windows NT 10.0;')) {
                // Windows 10æˆ–11éƒ½ä½¿ç”¨Windows NT 10.0ä½œä¸ºåŸºç¡€ç‰ˆæœ¬
                // æ£€æŸ¥æ˜¯å¦æœ‰Win64æˆ–x64æ ‡è¯†ï¼Œä»¥åŠå¯èƒ½çš„å…¶ä»–Windows 11ç‰¹å¾
                // æˆ–è€…ç›´æ¥å‡è®¾ç°ä»£Windows 10ç³»ç»Ÿéƒ½æ”¯æŒèƒŒæ™¯ææ–™
                return true;
            }

            // æ–¹æ³•3ï¼šæ£€æŸ¥æ˜¯å¦æ”¯æŒbackdrop-filterå±æ€§
            const isBackdropSupported = CSS.supports('backdrop-filter', 'blur(10px)');
            console.log('Backdrop Filter Supported:', isBackdropSupported);

            return isBackdropSupported;
        }

        // æ›´æ–°é¡µé¢èƒŒæ™¯è‰²
        function updatePageBackground(theme) {
            const appWindow = document.querySelector('.app-window');
            if (!appWindow) return;

            if (theme === 'dark') {
                appWindow.style.backgroundColor = '#1e1e1e';
            } else {
                appWindow.style.backgroundColor = '#f3f3f3';
            }
        }

        // åˆå§‹åŒ–é¡µé¢è®¾ç½®
        async function initPage() {
            const isWin11 = await isWindows11();
            const backdropGroup = document.getElementById('backdropGroup');
            const appWindow = document.querySelector('.app-window');

            if (!isWin11) {
                // éWindows 11ç³»ç»Ÿï¼Œç¦ç”¨èƒŒæ™¯ææ–™é€‰é¡¹
                if (backdropGroup) {
                    const buttons = backdropGroup.querySelectorAll('button');
                    buttons.forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('disabled');
                    });
                }

                // è®¾ç½®åˆå§‹èƒŒæ™¯è‰²
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                updatePageBackground(currentTheme);
            }
        }

        // ç›‘å¬ä¸»é¢˜è®¾ç½®æ¶ˆæ¯========================å¼€å§‹
        function updateSystemTheme() {
            const isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
            const theme = isDark ? "dark" : "light";
            document.documentElement.setAttribute('data-theme', theme);
            console.log('ç³»ç»Ÿä¸»é¢˜å·²æ›´æ–°ä¸º:', theme);

            // æ£€æŸ¥æ˜¯å¦ä¸ºWindows 11ï¼ŒéWindows 11åˆ™æ›´æ–°èƒŒæ™¯è‰²
            isWindows11().then(isWin11 => {
                if (!isWin11) {
                    updatePageBackground(theme);
                }
            });
        }

        // åˆå§‹æ£€æµ‹
        updateSystemTheme();
        // åˆå§‹åŒ–é¡µé¢
        initPage();
        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateSystemTheme);
        //ç›‘å¬ä¸»é¢˜è®¾ç½®æ¶ˆæ¯===================ç»“æŸ



        // æ ‡é¢˜æ æŒ‰é’®åŠŸèƒ½å®ç° - ä½¿ç”¨æ–°çš„invoke API
        async function sendWindowAction(action) {
            try {
                await jade.invoke('windowAction', action);
                console.log(`å‘é€çª—å£æ“ä½œæ¶ˆæ¯: ${action}`);
            } catch (error) {
                console.error(`å‘é€çª—å£æ“ä½œæ¶ˆæ¯å¤±è´¥: ${action}`, error);
            }
        }

        // ç›‘å¬çª—å£çŠ¶æ€å˜åŒ–äº‹ä»¶ï¼Œç”¨äºæ›´æ–°æœ€å¤§åŒ–/è¿˜åŸæŒ‰é’®ï¼ˆä½¿ç”¨æ–°çš„on APIï¼‰
        jade.on('window-state-changed', function (payload) {
            const btnMaximize = document.querySelector('.btn-maximize') || document.querySelector('.btn-restore');
            if (btnMaximize) {
                if (payload.isMaximized) {
                    // çª—å£å·²æœ€å¤§åŒ–ï¼Œæ˜¾ç¤ºè¿˜åŸå›¾æ ‡
                    btnMaximize.classList.add('btn-restore');
                    btnMaximize.classList.remove('btn-maximize');
                } else {
                    // çª—å£æœªæœ€å¤§åŒ–ï¼Œæ˜¾ç¤ºæœ€å¤§åŒ–å›¾æ ‡
                    btnMaximize.classList.add('btn-maximize');
                    btnMaximize.classList.remove('btn-restore');
                }
            }
        });


    </script>
</body>

</html>